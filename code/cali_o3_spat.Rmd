---
title: "California Ground-level Ozone Analysis and Modeling"
author: "<h3>Tarrik Quneibi</h3>"
date: "`r format(Sys.time(), '%B %Y')`"
output:
  html_document:
    theme: journal
    highlight: tango
    toc: true
    number_sections: true
    toc_depth: 2
    toc_float:
      collapsed: false
      smooth_scroll: true
    code_folding: show
    self_contained: yes
---
```{r setup, include = TRUE, echo=FALSE, message=FALSE,warning=FALSE}
knitr::opts_chunk$set(
    cache       = TRUE,     # if TRUE knitr will cache the results to reuse in future knits
    fig.width   = 9,       # the width for plots created by code chunk
    fig.height  = 9,       # the height for plots created by code chunk
    fig.align   = 'center', # how to align graphics in the final doc. 'left', 'right', 'center'
    echo        = FALSE,     # in FALSE knitr will not display code in the code chunk above it's results
    message     = FALSE,     # if FALSE knitr will not display any messages generated by code
    strip.white = TRUE,     # if FALSE knitr will not remove white spaces at the beg or end of code chunk
    warning     = FALSE)    # if FALSE knitr will not display any warning messages in the final document
```


```{r library, echo=FALSE, message=FALSE,warning=FALSE}
library(rvest)
library(sp)
library(leaflet)
library(leaflet.extras)
library(sf)
library(lubridate)
library(tidyverse)
library(plotly)
library(gganimate)
library(kableExtra)
library(tibble)
library(zoo)
library(xgboost)
library(stats)
library(corrplot)
```

# Background

Ground level ozone formation mostly occurs when nitrogen oxides (NO~x~), carbon monoxide (CO), and volatile organic compounds (VOCs), react in the atmosphere in the presence of UV (sunlight). Motor vehicle exhaust, industrial emissions, and chemical solvents are the major sources of these pollutants in urban areas, although winds can carry NO~x~ hundreds of kilometers, causing ozone formation to occur in less populated regions as well. 
Ground level ozone can be harmful to human health in higher concentrations with the NIOSH recommended exposure limit for ozone to be 0.1 ppm (0.2 mg/m3).
```{r data input, echo=FALSE, message=FALSE,warning=FALSE}
ozone_url <- "https://wiki.socr.umich.edu/index.php/SOCR_Data_121608_CA_US_OzoneData"
wiki_ozone <- read_html(ozone_url) # UCLA SOCR Data
ozone_data <- as.data.frame(html_table(html_nodes(wiki_ozone, "table")[[1]]), header = FALSE)

global_temp <- read_csv("C:/Users/Tarri/Desktop/portfolio_projects/ozone_spat_dashboard/data/global_temp.csv")

ozone_yr_url <- "https://wiki.socr.umich.edu/index.php/SOCR_Data_121608_OzoneData"
wiki_ozone_yr <- read_html(ozone_yr_url) # UCLA SOCR Data
ozone_yr_data <- as.data.frame(html_table(html_nodes(wiki_ozone_yr, "table")[[1]]), header = FALSE)

pollutant_data <- read_csv("C:/Users/Tarri/Desktop/portfolio_projects/ozone_spat_dashboard/data/pollutant.csv")
```

```{r data pull, echo=FALSE, message=FALSE,warning=FALSE}
## This chunk will pull data for the pollutants and the given years. 
## It will save out the dataframe to a csv that is called in the code above.
# pollutants <- c("OZONE","NOX","CO","NO2","NO","SO2","PM25")
# years <- seq(2010, 2022, by=1)
# 
# df <- data.frame()
# for (pol in pollutants){
#   for (year in years){
#     url <- paste("https://www.arb.ca.gov/aqmis2/display.php?param=",pol,"&units=007&statistic=DAVG&year=",year,"&mon=1&day=1&county_name=--COUNTY--&basin=--AIR+BASIN--&latitude=A-Whole+State&report=AREA1YR&order=basin%2Ccounty_name%2Cs.name&submit=Retrieve+Data&ptype=aqd&std15=",sep="")
#     cal_data <- read_html(url) # UCLA SOCR Data
#     pol_data <- as.data.frame(html_table(html_nodes(cal_data, "table")[[2]]), header = TRUE)
#     pol_data <- pol_data[3:34 , 1:13]
#     names(pol_data) <- pol_data[1,]
#     pol_data <- pol_data[-1,]
#     pol_data <- as.data.frame(sapply(pol_data, as.numeric))
#     month_avg <- colMeans(pol_data[ , 2:13], na.rm = TRUE)
#     pol_data <- data.frame(concentration = month_avg, year = year, contaminant = pol)
#     df <- rbind(df, pol_data)
#   }
# 
# }
# df <- tibble::rownames_to_column(df, "month")
# write.csv(df, "C:\\Users\\Tarri\\Desktop\\portfolio_projects\\ozone_spat_dashboard\\data\\pollutant.csv")
```

# California Ozone Data
Taking a look at the California ozone data in 2005 from the California Air Resources Board (CARB), we see that the data are composed of date, location, concentration, and spatial geometry columns. This spatial geometry data allows us to use GIS mapping packages, such as leaflet used here, to plot our data across a spatial area.

```{r convert to spatial df, echo=FALSE, message=FALSE,warning=FALSE, fig.align='center'}
ozone_spat <- st_as_sf(ozone_data, coords = c("Longitude","Latitude") , crs = 4326) 
kable(ozone_spat, "html", caption="California Ozone Concentration Data") %>%
    kable_styling() %>%
    scroll_box(width = "100%", height = "500px")

```

# Ozone Density
Plotting the density shows that the average concentration of ozone is about 0.065, and has multiple peaks, such as at concentrations of 0.036,0.059, and 0.079. This likely helps to establish the average since both high peaks are on either side of the mean.

```{r density, echo=FALSE, message=FALSE,warning=FALSE, fig.align='center'}

p1<-ggplot(ozone_spat, aes(x=O3)) + 
  geom_histogram(aes(y=..density..), colour="black", fill="white")+
  geom_density(alpha=.2, fill="#56B4E9") +
  labs(x="Ozone Concentration(ppm)",y="Density")+
  theme(axis.text=element_text(size=12), axis.title=element_text(size=14))
ggplotly(p1)

```

# Interactive Spatial Map
Plotting the ozone concentration data in leaflet and overlaying a heatmap shows that the highest concentrations of ozone occur in the Los Angeles, and Sacramento areas. 

```{r plot map,echo=FALSE, message=FALSE,warning=FALSE, fig.align='center'}

pal <- colorBin("Spectral", domain = ozone_spat$O3, bins = seq(0,max(ozone_spat$O3),length.out=6), na.color = "transparent",reverse=TRUE)

ozone_spat %>%
  leaflet() %>% 
  addTiles() %>% 
  addProviderTiles(providers$OpenStreetMap.DE) %>% 
  addHeatmap(lng = ozone_data$Longitude, lat=ozone_data$Latitude, intensity=~O3) %>%
  addLegend(pal = pal, values = ~O3, group = "circles", position = "bottomleft")



```

# Surface map
To get a different look on the spatial ozone concentration, a kernel density plot was created. This shows the two high concentration areas as the previous plot (Los Angeles, and Sacramento), but also gives a better picture of the areas around the two cities. Looking a the two peaks, we can see that one peak (Sacramento) tapers off quickly as we move away, while the other peak (Los Angeles) tapers off more gradually.

```{r surface plot, echo=FALSE, message=FALSE,warning=FALSE, fig.align='center'}

ozone_surf <- ozone_data %>%
  select(c("O3","Longitude","Latitude"))

kernal_density <- with(ozone_surf, MASS::kde2d(Longitude, Latitude, n = 50))
with(kernal_density, plot_ly(x=x, y=y, z=z, type="surface")%>% layout(scene = list( 
                       xaxis = list(title = 'Longitude'), 
                       yaxis = list(title = 'Latitude'),
                       zaxis = list(title = "Ozone probability density")
                       )))

  
```

# Historic Ozone Concentration Data
To see how the ozone concentration has changed over time, historic data from  the California Air Resources Board (CARB) was used along with global temperature anomaly data from NASA. Looking at the data table below, we see that the data consists of date, location, annual average ozone concentration, latitude, longitude, ground elevation, and the temperature change columns. 

```{r animation, echo=FALSE, message=FALSE,warning=FALSE, fig.align='center'}

global_temp <- global_temp %>%
  rename("Date"="Year")
global_temp$Date <- paste(global_temp$Date , "-01-01", sep="")
global_temp$Date <- ymd(global_temp$Date)
global_temp$Date <-  format(as.Date(global_temp$Date, format="%d/%m/%Y"),"%Y")

ozone_yr_data <- ozone_yr_data %>%
  rename("Date"="YEAR")
ozone_yr_data$Date <- paste(ozone_yr_data$Date , "-01-01", sep="")
ozone_yr_data$Date <- ymd(ozone_yr_data$Date)
ozone_yr_data$Date <-  format(as.Date(ozone_yr_data$Date, format="%d/%m/%Y"),"%Y")

ozone_temp <- merge( ozone_yr_data, global_temp, by="Date")
ozone_temp <- subset(ozone_temp, ANNUAL < 5)
ozone_lin <- ozone_temp
ozone_temp <- ozone_temp %>%
  select(c("Date","LOCATION","ANNUAL","LATITUDE","LONGITUDE","ELEVATION","Lowess"))

kable(ozone_temp, "html", caption="California Ozone Concentration and Global Temperature Anomaly Data") %>%
    kable_styling() %>%
    scroll_box(width = "100%", height = "500px")

```

# Ozone concentration Vs. Global Temperature over time
The animated plot below shows how the ozone concentration and global temperature has changed over time. This shows that on average the overall ozone concentration and range has decreased even though the global temperature has steadily increased. This could be due to many different variables but most likely is from stricter emissions regulations in California. Since ozone is formed from the reaction between UV and other air pollutants, reducing the concentration of air pollutants would reduce the ozone concentration even if UV intensity increased.

```{r plotly, echo=FALSE, message=FALSE,warning=FALSE, fig.align='center'}

ozone_temp %>%
  plot_ly(
    x = ~ANNUAL, 
    y = ~Lowess,
    color = ~LOCATION,
    frame = ~Date,
    type = 'scatter',
    mode="markers"
  ) %>%
  layout(
         xaxis = list(title = 'Annual Average Ozone Concentration (ppm)',
                      zerolinecolor = '#ffff',
                      zerolinewidth = 2,
                      gridcolor = 'ffff'),
         yaxis = list(title = 'Temperature Anomaly (C)',
                      zerolinecolor = '#ffff',
                      zerolinewidth = 2,
                      gridcolor = 'ffff'),
         plot_bgcolor='#e5ecf6')
```

# Ozone Concentration Over Time
We saw previously that the annual average ozone concentration was decreasing and the range was narrowing. To see how the concentration at all locations has changed over time, the scatter plot below was created. This shows a steeps decrease in ozone concentration from the year 1980 to 2000, with a plateau from 2000 to 2005.

```{r boxplot, echo=FALSE, message=FALSE,warning=FALSE, fig.align='center'}
ozone_box <- ozone_temp %>%
  select(c("LOCATION","ANNUAL", "Date")) 
ozone_box$LOCATION <- as.character(ozone_box$LOCATION)
ozone_box$Date <- as.numeric(ozone_box$Date)


plot_ly(ozone_box, x = ~Date, y = ~ANNUAL, color = ~LOCATION, type = "scatter") %>%
  layout(legend = list(title = list(text = "Station")),
         xaxis = list(title = 'Date',
                      zerolinecolor = '#ffff',
                      zerolinewidth = 2,
                      gridcolor = 'ffff'),
         yaxis = list(title = 'Annual Average Ozone Concentration (ppm)',
                      zerolinecolor = '#ffff',
                      zerolinewidth = 2,
                      gridcolor = 'ffff'),
         plot_bgcolor='#e5ecf6')

```



```{r all polutants, echo=FALSE, message=FALSE,warning=FALSE, fig.align='center'}
poll_data <- pollutant_data
poll_data$month <- gsub('[[:digit:]]+', ' ', poll_data$month)
poll_data$month <- str_trim(poll_data$month, side = c("both"))
poll_data$month <- paste(poll_data$month, "01", sep="-")
poll_data$time <- paste(poll_data$year,poll_data$month,sep="-")
poll_data$time <- strptime(poll_data$time,format="%Y-%b-%d")
poll_data <- poll_data %>% select(-c("month","year","...1"))

pol <- poll_data %>%
  group_by(time) %>%
  mutate(id_rows = row_number()) %>%
  pivot_wider( 
    id_cols = c(time),
    names_from = id_rows,
    values_from = concentration,
    names_prefix = "contaminant"
  ) %>% 
  ungroup()
colnames(pol) <- c("time","ozone","NOx","CO","NO2","NO","SO2","PM25")
pol$index <- seq(1,156, by=1)

```

# Correlation of parameters
Looking at the correlation plot, we see that a few parameters are highly correlated (positive and negative), however many do not seem to be correlated at all. Of note, ozone appears to be negatively correlated with No, NO~x~ and, NO~2~ which is to be expected since NO~x~ will react in the atmosphere to produce ozone. Since there are some correlation between these contaminants, a simple linear regression model was trained to predict ozone concentrations given the other pollutant concentrations.

```{r correlation plot, echo=FALSE, message=FALSE,warning=FALSE, fig.align='center'}
M <- pol[-length(pol$ozone), ]
M <- M %>%
    dplyr::mutate(., 
                  months = lubridate::month(time),
                  years = lubridate::year(time))
M <- M %>% select(-c("time","index"))
C = cor(M)
corrplot(C, method = 'ellipse', order = 'AOE', type = 'upper')


```


```{r linear model all pol, echo=FALSE, message=FALSE,warning=FALSE, fig.align='center'}
set.seed(42)
# Generate 90-10% training-testing split of the reviews
all_ids = pol$index
train_ids = sample(all_ids, length(pol$index)*0.8)
test_ids = setdiff(all_ids, train_ids)
train <- pol[pol$index %in% train_ids , ]
test <- pol[pol$index %in% test_ids, ]
train1 <- train%>%
  select(-c("index","time"))
test1 <- test %>%
  select(-c("index","time"))

reg_mod <- lm(ozone~.,data=train1)
predicted= predict(reg_mod,test1)

df <- data.frame(predicted, test$time, test$ozone)
df$error <- abs(((df$predicted-df$test.ozone)/df$test.ozone))
df$accuracy <- 1-df$error
accuracy <- round(mean(df$accuracy),2)
r_sqr <- round(summary(reg_mod)$r.squared, 2)
corr_lin <- round(cor(df$test.ozone, df$predicted),2)
```

# Building a Linear Model
The linear regression model was trained using a 80:20 split for training and testing data at random time points throughout the main dataframe. The correlation between the actual ozone concentration and the predicted values was found to be `r corr_lin`. This correlation is not entirely bad, but other machine learning models may be able to get a better fit. By comparing the actual vs. predicted values over time, we see that the linear model follows the general trend of the concentrations, but does over fit occasionally.

```{r linear model plots, echo=FALSE, message=FALSE,warning=FALSE, fig.align='center'}

plot_ly(df, x = ~test.ozone, y = ~predicted, type = "scatter", mode="markers") %>%
  layout(title =paste("Correlation is", round(cor(df$test.ozone, df$predicted),2)),
         xaxis = list(title = 'Actual ozone concentration (ppm)',
                      zerolinecolor = '#ffff',
                      zerolinewidth = 2,
                      gridcolor = 'ffff'),
         yaxis = list(title = 'Predicted ozone concentration (ppm)',
                      zerolinecolor = '#ffff',
                      zerolinewidth = 2,
                      gridcolor = 'ffff'),
         plot_bgcolor='#e5ecf6',
         shapes = list(list(
    type = "line", 
    x0 = ~min(test.ozone, predicted), 
    x1 = ~max(test.ozone, predicted), 
    xref = "x",
    y0 = ~min(test.ozone, predicted), 
    y1 = ~max(test.ozone, predicted),
    yref = "y",
    line = list(color = "black")
  )))

plot_ly(df, x = ~test.time, y = ~predicted, type = "scatter", mode="lines", name="Predicted") %>%
  add_trace(df, x=~test.time, y = ~test.ozone, name="Actual") %>%
  layout(
         xaxis = list(title = 'Date',
                      zerolinecolor = '#ffff',
                      zerolinewidth = 2,
                      gridcolor = 'ffff'),
         yaxis = list(title = 'Predicted ozone concentration (ppm)',
                      zerolinecolor = '#ffff',
                      zerolinewidth = 2,
                      gridcolor = 'ffff'),
         plot_bgcolor='#e5ecf6')


```

```{r xgboost, echo=FALSE, message=FALSE,warning=FALSE, fig.align='center'}
set.seed(42)
xg_pol <- pol[-length(pol$ozone), ]
xg_pol <- xg_pol %>%
    dplyr::mutate(., 
                  months = lubridate::month(time),
                  years = lubridate::year(time))
all_ids = xg_pol$index
train_ids = sample(all_ids, length(xg_pol$index)*0.8)
test_ids = setdiff(all_ids, train_ids)
xg_train <- xg_pol[xg_pol$index %in% train_ids , ]
xg_test <- xg_pol[xg_pol$index %in% test_ids, ]



xg_train_out <- data.matrix(xg_train %>% select("ozone"))
xg_train_in <- data.matrix(xg_train %>% select(-c("time","index","ozone")))
xg_test_out <- data.matrix(xg_test %>% select("ozone"))
xg_test_in <- data.matrix(xg_test %>% select(-c("time","index","ozone")))

dtrain <- xgb.DMatrix(data = xg_train_in, label= xg_train_out)
dtest <- xgb.DMatrix(data = xg_test_in, label= xg_test_out)

```


```{r xg model, echo=FALSE, message=FALSE,warning=FALSE, fig.align='center'}
set.seed(42)
## Setting the parameters for crossvalidation and model training
params <- list(booster = "gbtree",
              eta=0.4,
              gamma=0,
              objective = "reg:logistic"
               )
#Cross-validation to find the appropriate number of iterations to use in the model
xgb_iter <- xgb.cv(data = dtrain
                  , param = params
                  , maximize = FALSE, evaluation = "rmse", nrounds = 100
                  , nthreads = 10, nfold = 2, early_stopping_round = 10,verbose=0, showsd=FALSE)



#Setting the best number of iterations and training the model
num_iterations = xgb_iter$best_iteration

model <- xgb.train(data = dtrain
                               , param = params
                               , maximize = FALSE, eval_metric = 'rmse', nrounds = num_iterations, verbose=0)

pred <- predict(model, dtest)

full_data <- data.frame("ozone" = xg_test$ozone , "prediction" = pred, "date"=xg_test$time)
corr_xg <- round(cor(full_data$ozone, full_data$prediction),2)
```

# XGBoost predictive model
XGBoost is a variation of the Gradient Boosted Decision Trees algorithm. Essentially, this work by going through cycles that repeatedly build new models and combine them into a group of models. The cycle begins by calculating the errors in an existing model for each observation in the data set. A new model is then built to predict these errors. The predictions are then  moved from this error-predicting model to the group of models. This cycle continues for the number of iterations specified.
        
The model was built using a logistic regression objective function, with `r num_iterations`. The number of iterations was optimized by running cross validation on the dataset for 100 iterations and finding the stabilization point. Since this is time series data, the time data was split into month and year columns to account for seasonal variability. The correlation between the actual ozone concentration and the predicted was found to be `r corr_xg`. This value is much higher than the basic linear model and could be further optimized by varying other model parameters such as early stopping rounds, objective function, and max depth. When plotting the actual and predicted concentrations over time, we can see that the XGBoost model follows the actual trend much more closely than the linear model, but could still be tuned for proper fitting.

```{r xgboost plots, echo=FALSE, message=FALSE,warning=FALSE, fig.align='center'}
plot_ly(full_data, x = ~ozone, y = ~prediction, type = "scatter", mode="markers") %>%
  layout(title =paste("Correlation is", round(cor(full_data$ozone, full_data$prediction),2)),
         xaxis = list(title = 'Actual ozone concentration (ppm)',
                      zerolinecolor = '#ffff',
                      zerolinewidth = 2,
                      gridcolor = 'ffff'),
         yaxis = list(title = 'Predicted ozone concentration (ppm)',
                      zerolinecolor = '#ffff',
                      zerolinewidth = 2,
                      gridcolor = 'ffff'),
         plot_bgcolor='#e5ecf6',
         shapes = list(list(
    type = "line", 
    x0 = ~min(ozone, prediction), 
    x1 = ~max(ozone, prediction), 
    xref = "x",
    y0 = ~min(ozone, prediction), 
    y1 = ~max(ozone, prediction),
    yref = "y",
    line = list(color = "black")
  )))

plot_ly(full_data, x = ~date, y = ~prediction, type = "scatter", mode="lines", name="Predicted") %>%
  add_trace(df, x=~date, y = ~ozone, name="Actual") %>%
  layout(
         xaxis = list(title = 'Date',
                      zerolinecolor = '#ffff',
                      zerolinewidth = 2,
                      gridcolor = 'ffff'),
         yaxis = list(title = 'Predicted ozone concentration (ppm)',
                      zerolinecolor = '#ffff',
                      zerolinewidth = 2,
                      gridcolor = 'ffff'),
         plot_bgcolor='#e5ecf6')
```




